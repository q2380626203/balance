# ESP32å¹³è¡¡è½¦é¡¹ç›®

åŸºäºESP32å’ŒKY9250ä¹è½´ä¼ æ„Ÿå™¨çš„æ™ºèƒ½å¹³è¡¡æ§åˆ¶ç³»ç»Ÿï¼Œå®ç°åŸºäºPITCHè§’åº¦çš„ç²¾ç¡®å§¿æ€æ§åˆ¶ã€‚

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªESP-IDFå¹³è¡¡è½¦æ§åˆ¶ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½ï¼š
- é€šè¿‡KY9250ä¹è½´ä¼ æ„Ÿå™¨è·å–å®æ—¶å§¿æ€æ•°æ®
- åŸºäºPITCHè§’åº¦è¿›è¡Œå¹³è¡¡æ§åˆ¶ï¼ˆå¹³è¡¡è½¦çš„æ­£ç¡®æ§åˆ¶è½´ï¼‰
- ç”µæœºé€Ÿåº¦è‡ªåŠ¨è°ƒèŠ‚
- å®æ—¶çŠ¶æ€ç›‘æ§å’Œè°ƒè¯•ä¿¡æ¯æ˜¾ç¤º
- æ¨¡å—åŒ–ä¼ æ„Ÿå™¨æ¶æ„ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

## ğŸ”¥ **KY9250æ•°æ®å¤„ç†æ–¹æ³•** 

### **å½“å‰å®ç°æ¶æ„ï¼ˆæ¨¡å—åŒ–è®¾è®¡ï¼‰**

ç³»ç»Ÿé‡‡ç”¨**æ¨¡å—åŒ–æ¶æ„**ï¼Œå°†ä¼ æ„Ÿå™¨å¤„ç†ç‹¬ç«‹å°è£…ï¼Œæä¾›çº¿ç¨‹å®‰å…¨çš„æ•°æ®è®¿é—®ï¼š

#### 1. **KY9250æ¨¡å—** (`main/ky9250.c/h`)

**æ¨¡å—åŒ–ç‰¹ç‚¹**ï¼š
```c
// å®Œæ•´çš„ä¼ æ„Ÿå™¨æ•°æ®ç»“æ„
typedef struct {
    float gx, gy, gz;        // è§’é€Ÿåº¦ (Â°/s)
    float ax, ay, az;        // åŠ é€Ÿåº¦ (g)
    float mx, my, mz;        // ç£åŠ›è®¡
    float roll, pitch, yaw;  // æ¬§æ‹‰è§’ (Â°)
    float q0, q1, q2, q3;    // å››å…ƒæ•°
    bool is_valid;           // æ•°æ®æœ‰æ•ˆæ€§
    uint32_t packet_count;   // åŒ…è®¡æ•°å™¨
    uint32_t timestamp;      // æ—¶é—´æˆ³
} ky9250_data_t;

// çº¿ç¨‹å®‰å…¨çš„æ•°æ®è®¿é—®æ¥å£
bool ky9250_get_data(ky9250_handle_t* handle, ky9250_data_t* data);
float ky9250_get_pitch(ky9250_handle_t* handle);  // ç›´æ¥è·å–PITCHè§’
float ky9250_get_roll(ky9250_handle_t* handle);
float ky9250_get_yaw(ky9250_handle_t* handle);
```

#### 2. **æ•°æ®è§£æä»»åŠ¡** (`ky9250_parse_task`)
ä½ç½®ï¼š`main/ky9250.c:75-125`

**æ ¸å¿ƒå¤„ç†å¾ªç¯**ï¼š
```c
void ky9250_parse_task(void* pvParameters) {
    uint8_t ubuf[52];
    uint8_t ucRxCnt = 0;
    uint8_t temp_byte;
    
    while (1) {
        // è¯»å–UARTæ•°æ®
        int len = uart_read_bytes(handle->uart_port, &temp_byte, 1, 10 / portTICK_PERIOD_MS);
        if (len > 0) {
            handle->total_bytes_received++;
            
            ubuf[ucRxCnt++] = temp_byte;
            
            // æ£€æŸ¥åŒ…å¤´ 0x50
            if (ubuf[0] != 0x50) {
                ucRxCnt = 0;
                continue;
            }
            
            // ç­‰å¾…å®Œæ•´52å­—èŠ‚æ•°æ®åŒ…
            if (ucRxCnt < 52) continue;
            
            // è§£ææ•°æ®åŒ…å¹¶æ›´æ–°å…±äº«æ•°æ®ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
            ky9250_data_t temp_data = {0};
            if (parse_ky9250_packet(ubuf, &temp_data)) {
                if (xSemaphoreTake(handle->data_mutex, pdMS_TO_TICKS(5)) == pdTRUE) {
                    handle->sensor_data = temp_data;
                    handle->sensor_data.packet_count++;
                    xSemaphoreGive(handle->data_mutex);
                }
            }
            
            ucRxCnt = 0;
        }
        
        vTaskDelay(pdMS_TO_TICKS(1));
    }
}
```

#### 3. **å¹³è¡¡æ§åˆ¶ä»»åŠ¡ä¸­çš„PITCHè§’è¯»å–**
ä½ç½®ï¼š`main/main.cpp:137-138`
```c
// ğŸ”¥ æ ¸å¿ƒï¼šç›´æ¥è¯»å–PITCHè§’åº¦ï¼ˆå¹³è¡¡è½¦çš„æ­£ç¡®æ§åˆ¶è½´ï¼‰
current_pitch = ky9250_get_pitch(g_ky9250_handle);  // çº¿ç¨‹å®‰å…¨è·å–
pitch_error = current_pitch - TARGET_PITCH_ANGLE;   // è®¡ç®—å¹³è¡¡è¯¯å·®
```

#### 4. **å®æ—¶æ˜¾ç¤ºç•Œé¢**
ä½ç½®ï¼š`main/main.cpp:48-78`

**çªå‡ºPITCHè§’æ˜¾ç¤º**ï¼š
```c
static void realtime_display_task(void *pvParameters) {
    const TickType_t refresh_rate = pdMS_TO_TICKS(500); // 2Hzåˆ·æ–°é¢‘ç‡
    TickType_t last_wake_time = xTaskGetTickCount();
    
    while (1) {
        vTaskDelayUntil(&last_wake_time, refresh_rate);
        
        // è·å–KY9250æ•°æ®
        ky9250_data_t sensor_data;
        bool data_valid = ky9250_get_data(g_ky9250_handle, &sensor_data);
        
        printf("\\033[2J\\033[H"); // æ¸…å±
        printf("=== ESP32 KY9250 å¹³è¡¡æ§åˆ¶ç³»ç»Ÿ ===\\n");
        
        if (data_valid) {
            // æ˜¾ç¤ºå§¿æ€æ•°æ®ï¼Œé‡ç‚¹å…³æ³¨Pitchè§’
            printf("**PITCH: %6.2fÂ°**  Roll: %6.2fÂ°  Yaw: %6.2fÂ°\\n",
                   sensor_data.pitch, sensor_data.roll, sensor_data.yaw);
            printf("å¹³è¡¡æ§åˆ¶: PITCH=%.2fÂ° (ç›®æ ‡%.1fÂ°Â±%.1fÂ°)\\n", 
                   sensor_data.pitch, TARGET_PITCH_ANGLE, PITCH_TOLERANCE);
        }
        
        fflush(stdout);
    }
}
```

### **ä¼˜åŒ–ç‰¹ç‚¹**

1. **ğŸ—ï¸ æ¨¡å—åŒ–æ¶æ„**ï¼šä¼ æ„Ÿå™¨åŠŸèƒ½ç‹¬ç«‹å°è£…ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
2. **ğŸ”’ çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«æ•°æ®ï¼Œé¿å…æ•°æ®ç«äº‰
3. **ğŸ“ æ­£ç¡®æ§åˆ¶è½´**ï¼šä½¿ç”¨PITCHè§’è¿›è¡Œå¹³è¡¡æ§åˆ¶ï¼Œè€ŒéYAWè§’
4. **âš¡ é«˜å“åº”é€Ÿåº¦**ï¼š200Hzæ§åˆ¶é¢‘ç‡ï¼Œ1msæ•°æ®å¤„ç†å‘¨æœŸ
5. **ğŸ“Š å®Œæ•´æ•°æ®**ï¼šæ”¯æŒ9è½´æ•°æ®å’Œå››å…ƒæ•°ï¼Œå¯æ‰©å±•æ›´å¤æ‚ç®—æ³•
6. **ğŸ›¡ï¸ æ•°æ®éªŒè¯**ï¼šæ ¡éªŒä½æ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§

### **æ•°æ®æµç¨‹å›¾**
```
KY9250ä¼ æ„Ÿå™¨ â†’ UARTæ¥æ”¶ â†’ è§£æä»»åŠ¡ â†’ äº’æ–¥é”ä¿æŠ¤ â†’ å¹³è¡¡æ§åˆ¶ â†’ å®æ—¶æ˜¾ç¤º
   200Hz        1ms      ç‹¬ç«‹ä»»åŠ¡     çº¿ç¨‹å®‰å…¨      PITCHè§’     2Hzåˆ·æ–°
    â†“           â†“          â†“           â†“            â†“           â†“
   å‘é€       å¿«é€Ÿæ¥æ”¶   52å­—èŠ‚åŒ…    å…±äº«æ•°æ®      è¯¯å·®è®¡ç®—    å¯è§†åŒ–ç•Œé¢
```

## ç¡¬ä»¶é…ç½®

### å¼•è„šè¿æ¥
```c
// KY9250ä¼ æ„Ÿå™¨è¿æ¥ (UART1)
#define KY9250_UART_RXD     GPIO_NUM_11  // ESP32 â† KY9250 TX
#define KY9250_UART_TXD     GPIO_NUM_10  // ESP32 â†’ KY9250 RX

// ç”µæœºæ§åˆ¶ (UART2)  
#define MOTOR_UART_TXD      GPIO_NUM_13  // ESP32 â†’ ç”µæœºæ§åˆ¶å™¨
#define MOTOR_UART_RXD      GPIO_NUM_12  // ESP32 â† ç”µæœºæ§åˆ¶å™¨
```

### é€šä¿¡å‚æ•°
- **æ³¢ç‰¹ç‡**: 115200 bps
- **æ•°æ®ä½**: 8ä½
- **åœæ­¢ä½**: 1ä½
- **æ ¡éªŒä½**: æ— 
- **ä¼ æ„Ÿå™¨è¾“å‡ºé¢‘ç‡**: 200Hzï¼ˆå›ºå®šï¼‰
- **æ•°æ®åŒ…æ ¼å¼**: 52å­—èŠ‚ï¼ŒåŒ…å«9è½´æ•°æ®å’Œå››å…ƒæ•°

## è½¯ä»¶æ¶æ„

### æ§åˆ¶å‚æ•°
```c
const float TARGET_PITCH_ANGLE = 0.0f;    // ç›®æ ‡pitchè§’åº¦ï¼ˆå¹³è¡¡ä½ç½®ï¼‰
const float PITCH_TOLERANCE = 3.0f;       // pitchè§’åº¦å®¹å·®ï¼ˆÂ±3åº¦ï¼‰
const float MOTOR_FIXED_SPEED = 15.0f;    // ç”µæœºå›ºå®šè½¬é€Ÿ
```

### ä¸»è¦ä»»åŠ¡
1. **ky9250_parse_task**: KY9250æ•°æ®è§£æä»»åŠ¡ï¼ˆä¼˜å…ˆçº§4ï¼‰
2. **balance_control_task**: å¹³è¡¡æ§åˆ¶ä¸»å¾ªç¯ï¼ˆä¼˜å…ˆçº§5ï¼Œ200Hzï¼‰
3. **realtime_display_task**: å®æ—¶æ˜¾ç¤ºç•Œé¢ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§3ï¼Œ2Hzï¼‰
4. **uart2_monitor_task**: ç”µæœºæ•°æ®ç›‘æ§ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§3ï¼‰

### æ–‡ä»¶ç»“æ„
```
main/
â”œâ”€â”€ main.cpp          # ä¸»ç¨‹åºå’Œå¹³è¡¡æ§åˆ¶é€»è¾‘
â”œâ”€â”€ ky9250.c          # KY9250ä¼ æ„Ÿå™¨æ¨¡å—å®ç°
â”œâ”€â”€ ky9250.h          # KY9250ä¼ æ„Ÿå™¨æ¨¡å—å¤´æ–‡ä»¶
â”œâ”€â”€ motor_control.cpp # ç”µæœºæ§åˆ¶æ¨¡å—å®ç°
â”œâ”€â”€ motor_control.h   # ç”µæœºæ§åˆ¶æ¨¡å—å¤´æ–‡ä»¶
â””â”€â”€ CMakeLists.txt    # æ„å»ºé…ç½®
```

## ç¼–è¯‘å’Œè¿è¡Œ

### ç¯å¢ƒè¦æ±‚
- ESP-IDF v4.4+
- CMake 3.16+
- æ”¯æŒC++11çš„ç¼–è¯‘å™¨

### ç¼–è¯‘æ­¥éª¤
```bash
# 1. è®¾ç½®ESP-IDFç¯å¢ƒ
. $HOME/esp/esp-idf/export.sh

# 2. é…ç½®é¡¹ç›®
idf.py set-target esp32s3

# 3. ç¼–è¯‘é¡¹ç›®
idf.py build

# 4. çƒ§å½•åˆ°è®¾å¤‡
idf.py -p /dev/ttyUSB0 flash

# 5. ç›‘æ§ä¸²å£è¾“å‡º
idf.py -p /dev/ttyUSB0 monitor
```

## æ§åˆ¶é€»è¾‘

### å¹³è¡¡ç®—æ³•
- **æ ¸å¿ƒåŸç†**: åŸºäºPITCHè§’è¿›è¡Œå¹³è¡¡æ§åˆ¶ï¼ˆå‰åå€¾å€’æ£€æµ‹ï¼‰
- **å¹³è¡¡åŒºé—´**: PITCHè§’åœ¨0Â°Â±3Â°èŒƒå›´å†…æ—¶ï¼Œç”µæœºåœæ­¢
- **å¤±è¡¡å“åº”**: PITCHè§’è¶…å‡ºå®¹å·®èŒƒå›´æ—¶ï¼Œå»¶æ—¶500msåå¯åŠ¨ç”µæœºè°ƒèŠ‚
- **æ§åˆ¶æ–¹å‘**: 
  - PITCH > 0Â°ï¼ˆå‰å€¾ï¼‰ï¼šç”µæœºåé€€ï¼ˆè´Ÿé€Ÿåº¦ï¼‰
  - PITCH < 0Â°ï¼ˆåå€¾ï¼‰ï¼šç”µæœºå‰è¿›ï¼ˆæ­£é€Ÿåº¦ï¼‰

### æ™ºèƒ½é‡å¯æœºåˆ¶
- **å˜åŒ–æ£€æµ‹**: 500mså†…PITCHè§’å˜åŒ–â‰¤1Â°æ—¶è§¦å‘ç”µæœºé‡å¯
- **å†·å´ä¿æŠ¤**: 1.5ç§’é‡å¯å†·å´æ—¶é—´ï¼Œé˜²æ­¢é¢‘ç¹æ“ä½œ
- **é«˜é¢‘æ¢å¤**: é‡å¯å500mså†…ä»¥10msé¢‘ç‡é«˜é¢‘å‘é€æ§åˆ¶æŒ‡ä»¤
- **é”™è¯¯æ¸…ç†**: æ¯3ç§’è‡ªåŠ¨æ¸…ç†ç”µæœºé”™è¯¯çŠ¶æ€

### å®‰å…¨æœºåˆ¶
- ç³»ç»Ÿå¯åŠ¨5ç§’å»¶æ—¶ï¼Œç¡®ä¿ä¼ æ„Ÿå™¨ç¨³å®š
- è¿ç»­é”™è¯¯æ£€æµ‹å’Œé‡ç½®æœºåˆ¶
- ç”µæœºä½¿èƒ½/å¤±èƒ½ä¸‰æ¬¡ç¡®è®¤å‘é€
- çœ‹é—¨ç‹—ç¦ç”¨ï¼Œé¿å…è°ƒè¯•ä¸­æ–­

## è°ƒè¯•å’Œç›‘æ§

### å®æ—¶çŠ¶æ€æ˜¾ç¤º
ç¨‹åºè¿è¡Œæ—¶ä¼šå®æ—¶æ˜¾ç¤ºï¼š
- **PITCHè§’åº¦**ï¼ˆé‡ç‚¹æ ‡è®°ï¼‰
- Rollå’ŒYawè§’åº¦
- 9è½´åŠ é€Ÿåº¦æ•°æ®
- ä¼ æ„Ÿå™¨åŒ…è®¡æ•°
- å¹³è¡¡æ§åˆ¶çŠ¶æ€
- UARTæ¥æ”¶ç»Ÿè®¡

### ä¸²å£è¾“å‡ºç¤ºä¾‹
```
=== ESP32 KY9250 å¹³è¡¡æ§åˆ¶ç³»ç»Ÿ ===
UART1: æ¥æ”¶1542å­—èŠ‚
**PITCH: -1.23Â°**  Roll: 0.45Â°  Yaw: 2.78Â°
Acc: 0.02 -0.98 0.15 | åŒ…#42
å¹³è¡¡æ§åˆ¶: PITCH=-1.23Â° (ç›®æ ‡0.0Â°Â±3.0Â°)
```

## åè®®è¯´æ˜

### KY9250æ•°æ®åŒ…æ ¼å¼
- **åŒ…å¤´**: 0x50
- **æ•°æ®é•¿åº¦**: 52å­—èŠ‚
- **æ ¡éªŒ**: ç¬¬49-51å­—èŠ‚æ ¡éªŒå€¼ä¸º128
- **æ•°æ®å†…å®¹**: 
  - å­—èŠ‚1-9: é™€èºä»ªæ•°æ® (gx,gy,gz)
  - å­—èŠ‚10-18: åŠ é€Ÿåº¦æ•°æ® (ax,ay,az)
  - å­—èŠ‚19-27: ç£åŠ›è®¡æ•°æ® (mx,my,mz)
  - å­—èŠ‚28-36: æ¬§æ‹‰è§’ (roll,pitch,yaw)
  - å­—èŠ‚37-48: å››å…ƒæ•° (q0,q1,q2,q3)

## æ³¨æ„äº‹é¡¹

1. **å¯åŠ¨é¡ºåº**: ç¡®ä¿åœ¨ç³»ç»Ÿå¯åŠ¨çš„5ç§’å†…ä¿æŒè®¾å¤‡é™æ­¢
2. **æ§åˆ¶è½´é€‰æ‹©**: å¹³è¡¡è½¦å¿…é¡»ä½¿ç”¨PITCHè§’ï¼Œä¸æ˜¯YAWè§’
3. **ç”µæºè¦æ±‚**: ç¡®ä¿ESP32å’Œä¼ æ„Ÿå™¨ä¾›ç”µç¨³å®š
4. **ä¸²å£å†²çª**: é¿å…å¤šä¸ªç¨‹åºåŒæ—¶å ç”¨ä¸²å£
5. **è§’åº¦èŒƒå›´**: PITCHè§’åº¦èŒƒå›´ä¸º-180Â°åˆ°+180Â°
6. **å®æ—¶æ€§èƒ½**: æ§åˆ¶å¾ªç¯è¿è¡Œåœ¨200Hzï¼Œç¡®ä¿å®æ—¶å“åº”

## æ›´æ–°æ—¥å¿—

### 2025-07-28 ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰
- **ğŸ”„ é‡æ„å¹³è¡¡æ§åˆ¶ç³»ç»Ÿ**: å®ç°KY9250æ¨¡å—åŒ–å¹¶æ”¹ç”¨PITCHè§’æ§åˆ¶
  - **ä¼ æ„Ÿå™¨æ¨¡å—åŒ–**: åˆ›å»ºç‹¬ç«‹çš„ky9250.c/hæ¨¡å—ï¼Œæä¾›çº¿ç¨‹å®‰å…¨æ¥å£
    - ä½ç½®ï¼š`main/ky9250.c`, `main/ky9250.h`
    - åŠŸèƒ½ï¼šå®Œæ•´çš„9è½´æ•°æ®è§£æï¼Œäº’æ–¥é”ä¿æŠ¤ï¼Œç»Ÿè®¡ä¿¡æ¯
  - **æ§åˆ¶è½´ä¿®æ­£**: ä»YAWè§’æ”¹ä¸ºPITCHè§’è¿›è¡Œå¹³è¡¡æ§åˆ¶
    - åŸå› ï¼šå¹³è¡¡è½¦åº”æ§åˆ¶å‰åå€¾å€’ï¼ˆPITCHï¼‰ï¼Œè€Œéå·¦å³æ—‹è½¬ï¼ˆYAWï¼‰
    - ä½ç½®ï¼š`main/main.cpp:137-148`
  - **å‚æ•°ä¿æŒ**: ä¿ç•™æ‰€æœ‰åŸå§‹è°ƒè¯•å‚æ•°ï¼ˆ3Â°å®¹å·®ï¼Œ15é€Ÿåº¦ï¼Œ500mså»¶æ—¶ç­‰ï¼‰
    - ç¡®ä¿å·²è°ƒè¯•å¥½çš„æ§åˆ¶ç‰¹æ€§ä¸å˜
  - **æ˜¾ç¤ºä¼˜åŒ–**: ç•Œé¢çªå‡ºæ˜¾ç¤ºPITCHè§’ï¼Œä¾¿äºè°ƒè¯•ç›‘æ§
    - ä½ç½®ï¼š`main/main.cpp:65`

### 2025-07-25
- **å¹³è¡¡æ§åˆ¶ç®—æ³•é‡å¤§ä¼˜åŒ–**: é‡æ„YAWè§’å˜åŒ–æ£€æµ‹å’Œç”µæœºé‡å¯æœºåˆ¶
  - **æ™ºèƒ½å˜åŒ–æ£€æµ‹**: æ”¹ä¸ºåŸºäºæ—¶é—´çª—å£(500ms)å’Œå˜åŒ–å¹…åº¦(1Â°)çš„ç»¼åˆåˆ¤æ–­
  - **ç”µæœºé‡å¯å†·å´æœºåˆ¶**: åŠ å…¥1.5ç§’å†·å´æ—¶é—´ï¼Œé˜²æ­¢é¢‘ç¹é‡å¯
  - **é‡å¯åé«˜é¢‘æ§åˆ¶**: é‡å¯å500mså†…ä»¥10msé¢‘ç‡é«˜é¢‘å‘é€é€Ÿåº¦æŒ‡ä»¤
  - **å®šæœŸé”™è¯¯æ¸…ç†**: æ–°å¢æ¯3ç§’è‡ªåŠ¨æ¸…ç†ç”µæœºé”™è¯¯çš„æœºåˆ¶

### 2025-07-22
- **å¹³è¡¡æ§åˆ¶ä¼˜åŒ–**: å°†ç”µæœºè°ƒæ•´æ–¹å‘å–åï¼Œæ”¹å–„å¹³è¡¡å“åº”æ•ˆæœ
  - æ§åˆ¶é€»è¾‘ï¼šPITCHè¯¯å·®æ­£å€¼æ—¶ç”µæœºåå‘è½¬åŠ¨ï¼Œè¯¯å·®è´Ÿå€¼æ—¶æ­£å‘è½¬åŠ¨

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨å¼€æºè®¸å¯è¯ï¼Œè¯¦æƒ…è¯·å‚è€ƒé¡¹ç›®æ ¹ç›®å½•çš„LICENSEæ–‡ä»¶ã€‚

---

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)